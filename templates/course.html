{% extends "layout.html" %}

{% block dialogue %}
    <div>
        {% if course_url != "" and course_url != None %}
            <h2>Let's continue with <a class="blocky-emphasis text-decoration-none" href="{{ course_url }}" target="_blank">{{ course_name }}</a>!</h2>
        {% else %}
            <h2>Let's continue with <span class="blocky-emphasis">{{ course_name }}</span>!</h2>
        {% endif %}
    </div>
{% endblock %}

{% block headline %}
    <div class="pt-2">
        <div class="progress" role="progressbar" aria-label="progressbar" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100">
            <div class="progress-bar" style="width: {{ progress }}%"></div>
        </div>
    </div>
{% endblock %}

{%block body %}
    <div class="container text-center px-5">
        <div class="row row-cols-1 g-4">
            {% for item in lessons %}
                <div class="card">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <!-- MAIN TASK -->
                            <div class="col" id="lesson-column">
                                <div class="row align-items-center">
                                    <div class="col-auto">
                                        <form method="POST" action="/update_status">
                                            <input type="hidden" id="lesson_id" name="lesson_id" value="{{ item.lesson_id }}">
                                            {% if item.status == "incomplete" %}
                                                <button type="submit" name="toggle_status" value="completed" class="btn btn-link p-0 rounded-circle">
                                                    <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                                                        <!--!Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.-->
                                                        <path fill="currentColor" d="M256 48a208 208 0 1 1 0 416 208 208 0 1 1 0-416zm0 464A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM369 209c9.4-9.4 9.4-24.6 0-33.9s-24.6-9.4-33.9 0l-111 111-47-47c-9.4-9.4-24.6-9.4-33.9 0s-9.4 24.6 0 33.9l64 64c9.4 9.4 24.6 9.4 33.9 0L369 209z"/>
                                                    </svg>
                                                </button>
                                            {% elif item.status == "completed" %}
                                                <button type="submit" name="toggle_status" value="incomplete" class="btn btn-link p-0 rounded-circle">
                                                    <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
                                                        <!--!Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.-->
                                                        <path fill="currentColor" d="M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM369 209L241 337c-9.4 9.4-24.6 9.4-33.9 0l-64-64c-9.4-9.4-9.4-24.6 0-33.9s24.6-9.4 33.9 0l47 47L335 175c9.4-9.4 24.6-9.4 33.9 0s9.4 24.6 0 33.9z"/>
                                                    </svg>
                                                </button>
                                            {% endif %}
                                        </form>
                                    </div>

                                    <div class="col text-start">
                                        <h5 class="card-title m-0">{{ item.lesson_name }}</h5>
                                    </div>

                                    <div class="col-auto px-0">
                                        <!-- Delete button - DO I WANT TO ADD A CONFIRM WINDOW??? -->
                                        <div class="position-relative top-button" role="button">
                                            <form method="POST" action="/delete_item">
                                                <input type="hidden" name="item_type" value="lesson">
                                                <input type="hidden" name="item_id" value="{{ item.lesson_id }}">
                                                <button type="submit" class="btn btn-link rounded-circle">
                                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon">
                                                        <!--!Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.-->
                                                        <path fill="currentColor" d="M135.2 17.7L128 32 32 32C14.3 32 0 46.3 0 64S14.3 96 32 96l384 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-96 0-7.2-14.3C307.4 6.8 296.3 0 284.2 0L163.8 0c-12.1 0-23.2 6.8-28.6 17.7zM416 128L32 128 53.2 467c1.6 25.3 22.6 45 47.9 45l245.8 0c25.3 0 46.3-19.7 47.9-45L416 128z"/>
                                                    </svg>
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Horizontal line visible only on small screens if there are tasks -->
                                <hr class="d-md-none my-3">

                            <!-- SUBTASKS -->
                            <div class="col text-start">
                                {% for task in tasks[item.lesson_id] %}
                                    <div class="row align-items-center mb-3 mb-lg-2">
                                        <div class="col-auto">
                                            <form method="POST" action="/update_status">
                                                <input type="hidden" id="course_id" name="course_id" value="{{ item.course_id }}">
                                                <input type="hidden" id="task_id" name="task_id" value="{{ task.task_id }}">
                                                {% if task.status == "incomplete" %}
                                                    <button type="submit" name="toggle_status" value="completed" class="btn btn-link p-0 rounded-circle">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-check-circle" viewBox="0 0 16 16">
                                                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                                                            <path d="m10.97 4.97-.02.022-3.473 4.425-2.093-2.094a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05"/>
                                                        </svg>
                                                    </button>
                                                {% elif task.status == "completed" %}
                                                    <button type="submit" name="toggle_status" value="incomplete" class="btn btn-link p-0 rounded-circle">
                                                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-check-circle-fill" viewBox="0 0 16 16">
                                                            <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0m-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
                                                        </svg>
                                                    </button>
                                                {% endif %}
                                            </form>
                                        </div>

                                        <div class="col text-start">
                                            <h5 class="card-title m-0">{{ task.task_name }}</h5>
                                        </div>

                                        <div class="col-auto px-0">
                                            <!-- Delete button - DO I WANT TO ADD A CONFIRM WINDOW??? -->
                                            <div class="position-relative top-button" role="button">
                                                <form method="POST" action="/delete_item">
                                                    <input type="hidden" name="item_type" value="task">
                                                    <input type="hidden" name="item_id" value="{{ task.task_id }}">
                                                    <button type="submit" class="btn btn-link rounded-circle">
                                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon">
                                                            <!--!Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.-->
                                                            <path fill="currentColor" d="M135.2 17.7L128 32 32 32C14.3 32 0 46.3 0 64S14.3 96 32 96l384 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-96 0-7.2-14.3C307.4 6.8 296.3 0 284.2 0L163.8 0c-12.1 0-23.2 6.8-28.6 17.7zM416 128L32 128 53.2 467c1.6 25.3 22.6 45 47.9 45l245.8 0c25.3 0 46.3-19.7 47.9-45L416 128z"/>
                                                        </svg>
                                                    </button>
                                                </form>
                                            </div>
                                        </div>

                                    </div>
                                {% endfor %}

                                {% if tasks[item.lesson_id] %}
                                    <hr class="d my-3">
                                {% endif %}

                                <div class="ps-3">
                                    <a class="card-block text-decoration-none" data-bs-toggle="modal" data-bs-target="#addTaskModal" data-bs-whatever="{{ item.lesson_id}}" role="button">
                                        <h5>
                                            <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512">
                                                <!--!Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.-->
                                                <path fill="currentColor" d="M256 80c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 144L48 224c-17.7 0-32 14.3-32 32s14.3 32 32 32l144 0 0 144c0 17.7 14.3 32 32 32s32-14.3 32-32l0-144 144 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-144 0 0-144z"/>
                                            </svg>
                                            Add new task
                                        </h5>
                                    </a>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}

            <div class="card new-item-card h-100">
                <div class="card-body">
                    <a class="card-block stretched-link text-decoration-none" data-bs-toggle="modal" data-bs-target="#addLessonModal" role="button">
                        <h5>
                            <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512">
                                <!--!Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.-->
                                <path fill="currentColor" d="M256 80c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 144L48 224c-17.7 0-32 14.3-32 32s14.3 32 32 32l144 0 0 144c0 17.7 14.3 32 32 32s32-14.3 32-32l0-144 144 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-144 0 0-144z"/>
                            </svg>
                            Start a new lesson
                        </h5>
                    </a>
                </div>
            </div>

        </div>
    </div>

    <!-- Add Lesson -->
    <div class="modal fade" id="addLessonModal" tabindex="-1" aria-labelledby="addLessonModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <form method="POST" action="/add_item">
                <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title fs-5" id="addLessonModalLabel">Add a lesson</h1>
                        <!-- <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> -->
                    </div>
                    <div class="modal-body">
                        <form>
                            <div class="mb-3">
                                <input type="hidden" name="item_type" value="lesson">
                                <input type="hidden" name="top-relation" value="{{ course_id }}">
                                <input type="text" class="form-control" name="item_name" placeholder="Enter lesson name" autocomplete="off">
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Start Learning</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Task -->
    <div class="modal fade" id="addTaskModal" tabindex="-1" aria-labelledby="addTaskModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <form method="POST" action="/add_item">
                <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title fs-5" id="addTaskModalLabel">Add a task</h1>
                        <!-- <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> -->
                    </div>
                    <div class="modal-body">
                        <form>
                            <div class="mb-3">
                                <input type="hidden" name="item_type" value="task">
                                <input type="hidden" name="top-relation" value=""> <!-- This will be set dynamically -->
                                <input type="text" class="form-control" name="item_name" placeholder="Enter task name" autocomplete="off">
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
{% endblock %}

{% block back %}
    <div class="container px-5 py-3 hidden">
        <a href="/skill{{ skill_id }}" class="btn back-button">
            <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512">
                <!--!Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2025 Fonticons, Inc.-->
                <path fill="currentColor" d="M9.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l160 160c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L109.2 288 416 288c17.7 0 32-14.3 32-32s-14.3-32-32-32l-306.7 0L214.6 118.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-160 160z"/></svg>
            Back
        </a>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        const taskModal = document.getElementById('addTaskModal')
        if (taskModal) {
        taskModal.addEventListener('show.bs.modal', event => {
            // Button that triggered the modal
            const button = event.relatedTarget
            // Extract info from data-bs-* attributes
            const lesson_id = button.getAttribute('data-bs-whatever')
            // If necessary, you could initiate an Ajax request here
            // and then do the updating in a callback.

            // Update the modal's content.
            const modalLessonId = taskModal.querySelector('.modal-body input[name="top-relation"]')
            modalLessonId.value = lesson_id
        })
        }
    </script>
{%  endblock %}